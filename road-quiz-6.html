<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bainbridge Island Road Quiz</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: #12151c;
      color: #dde1ea;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #header {
      background: #1a1f2e;
      border-bottom: 2px solid #2a3050;
      padding: 10px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      gap: 12px;
    }
    #header h1 {
      font-size: 1.05rem;
      font-weight: 700;
      color: #e05252;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }
    #header-stats { font-size: 0.82rem; color: #7a8299; }
    #main { flex: 1; display: flex; overflow: hidden; }
    #map { flex: 1; min-width: 0; position: relative; }
    #map-overlay {
      display: none;
      position: absolute;
      inset: 0;
      z-index: 1000;
      cursor: crosshair;
    }
    #sidebar {
      width: 300px;
      flex-shrink: 0;
      background: #1a1f2e;
      border-left: 2px solid #2a3050;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #sidebar-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .panel {
      background: #20273a;
      border: 1px solid #2a3050;
      border-radius: 8px;
      padding: 13px;
    }
    .panel-title {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #5a6380;
      margin-bottom: 10px;
    }
    .score-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 7px; }
    .score-cell { background: #12151c; border-radius: 6px; padding: 8px 6px; text-align: center; }
    .score-val { font-size: 1.6rem; font-weight: 700; color: #e05252; line-height: 1; }
    .score-val.green { color: #4caf50; }
    .score-lbl { font-size: 0.68rem; color: #5a6380; margin-top: 3px; }
    #progress-wrap { margin-top: 8px; }
    #progress-bar-track { height: 6px; background: #12151c; border-radius: 3px; overflow: hidden; }
    #progress-bar-fill {
      height: 100%;
      background: #4caf50;
      border-radius: 3px;
      transition: width 0.4s ease;
      width: 0%;
    }
    #progress-label { font-size: 0.7rem; color: #5a6380; margin-top: 4px; text-align: right; }
    #question-text {
      font-size: 0.88rem;
      color: #aab0c4;
      line-height: 1.5;
      margin-bottom: 10px;
      min-height: 2.5em;
    }
    #answer-input {
      width: 100%;
      background: #12151c;
      border: 2px solid #2a3050;
      border-radius: 6px;
      padding: 9px 11px;
      color: #dde1ea;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.15s;
      margin-bottom: 7px;
    }
    #answer-input:focus      { border-color: #e05252; }
    #answer-input.state-ok   { border-color: #4caf50; background: #141e14; }
    #answer-input.state-bad  { border-color: #e05252; background: #1e1414; }
    #answer-input.state-skip { border-color: #ff9800; background: #1e1a14; }
    #feedback {
      font-size: 0.82rem;
      padding: 7px 9px;
      border-radius: 5px;
      margin-bottom: 7px;
      display: none;
      line-height: 1.4;
    }
    #feedback.fb-ok   { display: block; background: #142014; color: #66bb6a; border: 1px solid #3a6a3a; }
    #feedback.fb-bad  { display: block; background: #201414; color: #ef5350; border: 1px solid #6a3a3a; }
    #feedback.fb-skip { display: block; background: #1e1a10; color: #ffa726; border: 1px solid #6a5a2a; }
    .btn-row { display: flex; gap: 7px; }
    .btn {
      flex: 1;
      padding: 9px 8px;
      border: none;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.1s;
    }
    .btn:active { transform: scale(0.97); }
    .btn:hover  { opacity: 0.88; }
    .btn-primary   { background: #e05252; color: #fff; }
    .btn-secondary { background: #2a3050; color: #9aa0b8; }
    .btn-area      { background: #2a3050; color: #ff9800; }
    .btn-arterial  { background: #2a3050; color: #9aa0b8; }
    .btn-arterial.active { background: #1a3a2a; color: #4caf50; border: 1px solid #3a7a4a; }
    .btn-mode.btn-learn.active { background: #1a2a3a; color: #4a90e2; border-color: #3a5a8a; }
    #arterial-status {
      display: none;
      font-size: 0.75rem;
      color: #4caf50;
      background: #142014;
      border: 1px solid #3a6a3a;
      border-radius: 5px;
      padding: 5px 8px;
      margin-top: 7px;
    }
    #hint-text { font-size: 0.75rem; color: #3a4060; margin-top: 5px; }
    #area-status {
      display: none;
      font-size: 0.75rem;
      color: #ff9800;
      background: #1e1a10;
      border: 1px solid #6a5a2a;
      border-radius: 5px;
      padding: 5px 8px;
      margin-top: 7px;
    }
    #area-drawing-hint {
      display: none;
      font-size: 0.75rem;
      color: #ff9800;
      margin-top: 5px;
      text-align: center;
    }
    .opt-row { display: flex; gap: 7px; }
    #road-count-lbl { display: inline; color: #5a6380; font-weight: 400; }
    #road-list { max-height: 180px; overflow-y: auto; margin-top: 2px; }
    #road-list::-webkit-scrollbar { width: 4px; }
    #road-list::-webkit-scrollbar-track { background: transparent; }
    #road-list::-webkit-scrollbar-thumb { background: #2a3050; border-radius: 2px; }
    .road-item {
      font-size: 0.77rem;
      padding: 3px 0;
      border-bottom: 1px solid #1a1f2e;
      color: #4a5070;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .road-item.mastered { color: #4caf50; }
    #loading {
      position: fixed;
      inset: 0;
      background: #12151c;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      gap: 14px;
    }
    .spinner {
      width: 44px; height: 44px;
      border: 4px solid #2a3050;
      border-top-color: #e05252;
      border-radius: 50%;
      animation: spin 0.75s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loading-msg { color: #5a6380; font-size: 0.9rem; }
    #loading-sub { color: #3a4060; font-size: 0.78rem; }
    #sidebar-scroll::-webkit-scrollbar { width: 4px; }
    #sidebar-scroll::-webkit-scrollbar-track { background: transparent; }
    #sidebar-scroll::-webkit-scrollbar-thumb { background: #2a3050; border-radius: 2px; }
    #completion {
      display: none;
      background: #142014;
      border: 1px solid #3a6a3a;
      border-radius: 7px;
      padding: 13px;
      color: #66bb6a;
      font-size: 0.88rem;
      line-height: 1.5;
      text-align: center;
    }
    .mode-toggle-row { display: flex; gap: 6px; margin-bottom: 11px; }
    .btn-mode {
      flex: 1; padding: 7px 6px; border: 1px solid #2a3050; border-radius: 6px;
      font-size: 0.75rem; font-weight: 600; cursor: pointer;
      background: #12151c; color: #5a6380; transition: all 0.15s;
    }
    .btn-mode.active { background: #2a3050; color: #dde1ea; border-color: #4a5580; }
    .btn-mode:hover:not(.active) { color: #9aa0b8; }
    #find-question { font-size: 0.82rem; color: #7a8299; margin-bottom: 8px; }
    #find-road-name {
      font-size: 1.05rem; font-weight: 700; color: #e8eaf0; text-align: center;
      padding: 10px 8px; margin-bottom: 9px; background: #12151c;
      border-radius: 6px; letter-spacing: 0.3px; line-height: 1.3;
    }
    #find-feedback {
      font-size: 0.82rem; padding: 7px 9px; border-radius: 5px;
      margin-bottom: 7px; display: none; line-height: 1.4;
    }
    #find-feedback.fb-ok   { display: block; background: #142014; color: #66bb6a; border: 1px solid #3a6a3a; }
    #find-feedback.fb-bad  { display: block; background: #201414; color: #ef5350; border: 1px solid #6a3a3a; }
    #find-feedback.fb-skip { display: block; background: #1e1a10; color: #ffa726; border: 1px solid #6a5a2a; }
    #find-hint { font-size: 0.75rem; color: #3a4060; margin-top: 5px; }
    #map.find-mode .leaflet-container { cursor: crosshair; }
    @media (max-width: 680px) { #sidebar { width: 260px; } }
    @media (max-width: 540px) {
      #main { flex-direction: column; }
      #sidebar { width: 100%; border-left: none; border-top: 2px solid #2a3050; max-height: 45vh; }
      #map { min-height: 200px; }
    }
  </style>
</head>
<body>
<div id="loading">
  <div class="spinner"></div>
  <div id="loading-msg">Loading Bainbridge Island road data...</div>
  <div id="loading-sub">Fetching from OpenStreetMap — this takes a few seconds</div>
</div>
<div id="header">
  <h1>Bainbridge Island Road Quiz</h1>
  <div id="header-stats"></div>
</div>
<div id="main">
  <div id="map">
    <div id="map-overlay"></div>
  </div>
  <div id="sidebar">
    <div id="sidebar-scroll">
      <div class="panel">
        <div class="panel-title">Score</div>
        <div class="score-grid">
          <div class="score-cell">
            <div class="score-val green" id="val-correct">0</div>
            <div class="score-lbl">Correct</div>
          </div>
          <div class="score-cell">
            <div class="score-val" id="val-total">0</div>
            <div class="score-lbl">Attempted</div>
          </div>
          <div class="score-cell">
            <div class="score-val" id="val-streak">0</div>
            <div class="score-lbl">Streak</div>
          </div>
          <div class="score-cell">
            <div class="score-val" id="val-mastered">0</div>
            <div class="score-lbl" id="lbl-mastered">Mastered</div>
          </div>
        </div>
        <div id="progress-wrap">
          <div id="progress-bar-track"><div id="progress-bar-fill"></div></div>
          <div id="progress-label">0 of 0 roads mastered</div>
        </div>
      </div>
      <div class="panel">
        <div class="mode-toggle-row">
          <button class="btn btn-mode active" id="mode-name-btn">&#9654; Name That Road</button>
          <button class="btn btn-mode"        id="mode-find-btn">&#9670; Find That Road</button>
          <button class="btn btn-mode btn-learn" id="mode-learn-btn">&#128218; Learn</button>
        </div>
        <div id="name-mode-ui">
          <div id="question-text">Initializing...</div>
          <input type="text" id="answer-input" placeholder="Type road name..." autocomplete="off" spellcheck="false" />
          <div id="feedback"></div>
          <div class="btn-row">
            <button class="btn btn-primary"   id="submit-btn">Submit</button>
            <button class="btn btn-secondary" id="skip-btn">Skip</button>
            <button class="btn btn-secondary" id="see-name-btn" style="display:none">See Name</button>
          </div>
          <div id="hint-text">Press Enter to submit &bull; Esc to skip</div>
        </div>
        <div id="find-mode-ui" style="display:none">
          <div id="find-question">Click on the map where you think this road is:</div>
          <div id="find-road-name"></div>
          <div id="find-feedback"></div>
          <div class="btn-row">
            <button class="btn btn-primary"   id="find-next-btn" style="display:none">Next Road</button>
            <button class="btn btn-secondary" id="find-skip-btn">Skip</button>
          </div>
          <div id="find-hint">Click the map &bull; Esc to skip</div>
        </div>
      </div>
      <div id="completion"></div>
      <div class="panel">
        <div class="panel-title">Options</div>
        <div class="opt-row">
          <button class="btn btn-secondary" id="zoom-btn">Zoom to Road</button>
          <button class="btn btn-secondary" id="reset-btn">Reset Quiz</button>
        </div>
        <div class="opt-row" style="margin-top:7px;">
          <button class="btn btn-arterial" id="arterial-btn">&#9654; Arterials Only</button>
        </div>
        <div id="arterial-status"></div>
        <div class="opt-row" style="margin-top:7px;">
          <button class="btn btn-area"      id="area-btn">&#9635; Select Area</button>
          <button class="btn btn-secondary" id="clear-area-btn" style="display:none;">Clear Area</button>
        </div>
        <div id="area-drawing-hint">Click &amp; drag on the map to draw a box &bull; Esc to cancel</div>
        <div id="area-status"></div>
      </div>
      <div class="panel">
        <div class="panel-title">All Roads <span id="road-count-lbl"></span></div>
        <div id="road-list"></div>
      </div>
    </div>
  </div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map', { center: [47.640, -122.520], zoom: 12, zoomControl: true });
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/">CARTO</a>',
  subdomains: 'abcd', maxZoom: 19,
}).addTo(map);

let roadsByName   = {};
let roadLayers    = {};
let roadNames     = [];
let quizQueue     = [];
let currentRoad   = null;
let awaitingNext  = false;
const score = { correct: 0, total: 0, streak: 0 };
const mastered = new Set();

let activeRoadNames  = null;
let activeAreaBounds = null;
let selectionLayer   = null;

let quizMode       = 'name';  // 'name' | 'find'
let pendingTimer   = null;
let findClickMarker = null;
let findClickLine   = null;
const FIND_THRESHOLD = 500;   // metres — within this counts as correct

const ARTERIAL_TYPES = new Set(['motorway', 'trunk', 'primary', 'secondary', 'tertiary']);
// Roads to always include in the arterials filter regardless of OSM classification
const NAMED_ARTERIALS = new Set([
  'Northeast Winther Road',
  'Northeast Lovegreen Road',
  'Northeast Roberts Road',
  'Northeast Torvanger Road',
  'Toe Jam Hill Road Northeast',
  'Northeast South Beach Drive',
  'Hansen Road Northeast',

]);
let arterialRoadNames = [];
let roadHighwayTypes  = {};
let arterialOnly      = false;
let learnRevealed     = false;  // true after See Name clicked for current question
let learnRecalled     = 0;      // self-recalled (no peek) count for learn mode session

const STYLE_DEFAULT  = { color: '#5577aa', weight: 2.5, opacity: 0.6 };
const STYLE_ACTIVE   = { color: '#e05252', weight: 6,   opacity: 1   };
const STYLE_CORRECT  = { color: '#4caf50', weight: 6,   opacity: 1   };
const STYLE_SKIP     = { color: '#ff9800', weight: 5,   opacity: 1   };
const STYLE_AREA_BOX = { color: '#ff9800', weight: 2, dashArray: '6 4', fillColor: '#ff9800', fillOpacity: 0.07, interactive: false };

const OVERPASS_ENDPOINTS = [
  'https://overpass-api.de/api/interpreter',
  'https://overpass.kumi.systems/api/interpreter',
  'https://maps.mail.ru/osm/tools/overpass/api/interpreter',
];

async function fetchRoads() {
  const query = `
[out:json][timeout:90];
area["name"="Bainbridge Island"]["admin_level"="8"]->.bi;
(
  way["highway"~"^(motorway|trunk|primary|secondary|tertiary|residential|unclassified|road)$"]
     ["name"]
     (area.bi);
);
out body;
>;
out skel qt;`.trim();

  const msgEl = document.getElementById('loading-msg');
  const subEl = document.getElementById('loading-sub');

  for (let attempt = 0; attempt < OVERPASS_ENDPOINTS.length; attempt++) {
    const endpoint = OVERPASS_ENDPOINTS[attempt];
    if (attempt > 0) {
      msgEl.textContent = `Trying mirror server ${attempt + 1} of ${OVERPASS_ENDPOINTS.length}…`;
      subEl.textContent = 'Main server busy — switching to backup';
      await new Promise(res => setTimeout(res, 1500));
    }
    try {
      const resp = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: query,
        signal: AbortSignal.timeout(100_000),
      });
      if (resp.status === 429 || resp.status === 504) continue;
      if (!resp.ok) throw new Error(`HTTP ${resp.status} from Overpass API`);
      return resp.json();
    } catch (e) {
      if (attempt === OVERPASS_ENDPOINTS.length - 1) throw e;
    }
  }
  throw new Error('All Overpass servers are busy — please wait a minute and retry.');
}

function parseRoads(data) {
  const nodeMap = {};
  for (const el of data.elements) {
    if (el.type === 'node') nodeMap[el.id] = [el.lat, el.lon];
  }
  const byName  = {};
  const hwTypes = {};
  for (const el of data.elements) {
    if (el.type !== 'way' || !el.tags?.name) continue;
    const name    = el.tags.name;
    const highway = el.tags.highway;
    const coords  = el.nodes.map(n => nodeMap[n]).filter(Boolean);
    if (coords.length < 2) continue;
    (byName[name] = byName[name] || []).push(coords);
    if (!hwTypes[name]) hwTypes[name] = new Set();
    hwTypes[name].add(highway);
  }
  roadHighwayTypes = hwTypes;
  return byName;
}

function renderRoads() {
  for (const [name, segments] of Object.entries(roadsByName)) {
    const lines = segments.map(coords => L.polyline(coords, { ...STYLE_DEFAULT }));
    roadLayers[name] = L.featureGroup(lines).addTo(map);
  }
}
function setRoadStyle(name, style) { roadLayers[name]?.eachLayer(l => l.setStyle(style)); }
function zoomToRoad(name) {
  const layer = roadLayers[name];
  if (!layer) return;
  try {
    const bounds = layer.getBounds();
    if (bounds.isValid()) map.fitBounds(bounds, { padding: [90, 90], maxZoom: 15 });
  } catch (_) {}
}

function filterRoadsInBounds(bounds) {
  return roadNames.filter(name =>
    roadsByName[name].some(seg => seg.some(([lat, lon]) => bounds.contains(L.latLng(lat, lon))))
  );
}

function enterSelectionMode() {
  const overlay = document.getElementById('map-overlay');
  const hint    = document.getElementById('area-drawing-hint');
  const areaBtn = document.getElementById('area-btn');
  overlay.style.display = 'block';
  hint.style.display    = 'block';
  areaBtn.textContent   = 'Drawing…';
  let drawStart = null, drawing = false;
  function onEsc(e) { if (e.key === 'Escape') cancelDraw(); }
  function cancelDraw() {
    overlay.style.display = 'none'; hint.style.display = 'none';
    areaBtn.textContent = '◻ Select Area';
    overlay.onmousedown = overlay.onmousemove = overlay.onmouseup = null;
    document.removeEventListener('keydown', onEsc);
    if (drawing && !activeAreaBounds && selectionLayer) { map.removeLayer(selectionLayer); selectionLayer = null; }
    drawing = false;
  }
  document.addEventListener('keydown', onEsc);
  overlay.onmousedown = (e) => {
    drawing = true;
    const rect = overlay.getBoundingClientRect();
    drawStart = map.containerPointToLatLng(L.point(e.clientX - rect.left, e.clientY - rect.top));
    if (selectionLayer) { map.removeLayer(selectionLayer); selectionLayer = null; }
    selectionLayer = L.rectangle([drawStart, drawStart], STYLE_AREA_BOX).addTo(map);
    overlay.onmousemove = (e2) => {
      const r = overlay.getBoundingClientRect();
      selectionLayer.setBounds(L.latLngBounds(drawStart, map.containerPointToLatLng(L.point(e2.clientX - r.left, e2.clientY - r.top))));
    };
    overlay.onmouseup = (e2) => {
      overlay.onmousemove = overlay.onmouseup = null;
      overlay.style.display = 'none'; hint.style.display = 'none';
      areaBtn.textContent = '◻ Select Area';
      document.removeEventListener('keydown', onEsc);
      drawing = false;
      const r      = overlay.getBoundingClientRect();
      const endPt  = map.containerPointToLatLng(L.point(e2.clientX - r.left, e2.clientY - r.top));
      const bounds = L.latLngBounds(drawStart, endPt);
      if (Math.abs(bounds.getNorth() - bounds.getSouth()) < 0.001 &&
          Math.abs(bounds.getEast()  - bounds.getWest())  < 0.001) {
        if (selectionLayer) { map.removeLayer(selectionLayer); selectionLayer = null; }
        return;
      }
      const filtered = filterRoadsInBounds(bounds);
      if (filtered.length === 0) {
        alert('No roads found in that area — try a larger selection.');
        if (selectionLayer) { map.removeLayer(selectionLayer); selectionLayer = null; }
        return;
      }
      activeAreaBounds = bounds; activeRoadNames = filtered;
      document.getElementById('clear-area-btn').style.display = '';
      document.getElementById('area-status').style.display    = 'block';
      updateAreaStatus(); updateRoadCountLabel(); startQuiz();
    };
  };
}

function clearAreaSelection() {
  activeAreaBounds = activeRoadNames = null;
  if (selectionLayer) { map.removeLayer(selectionLayer); selectionLayer = null; }
  document.getElementById('clear-area-btn').style.display = 'none';
  document.getElementById('area-status').style.display    = 'none';
  document.getElementById('area-status').textContent      = '';
  updateRoadCountLabel(); startQuiz();
}

function updateAreaStatus() {
  const el = document.getElementById('area-status');
  if (!activeRoadNames) { el.style.display = 'none'; return; }
  const visible = arterialOnly ? activeRoadNames.filter(n => arterialRoadNames.includes(n)) : activeRoadNames;
  el.textContent = `Area filter: ${visible.length} road${visible.length !== 1 ? 's' : ''}` + (arterialOnly ? ' (arterials)' : '');
}

function toggleArterial() {
  arterialOnly = !arterialOnly;
  const btn = document.getElementById('arterial-btn'), status = document.getElementById('arterial-status');
  if (arterialOnly) {
    btn.classList.add('active'); btn.textContent = '▶ Arterials Only ✓';
    status.style.display = 'block';
    status.textContent = `${arterialRoadNames.length} arterial road${arterialRoadNames.length !== 1 ? 's' : ''} (primary, secondary, tertiary…)`;
  } else {
    btn.classList.remove('active'); btn.textContent = '▶ Arterials Only'; status.style.display = 'none';
  }
  updateAreaStatus(); updateRoadCountLabel(); startQuiz();
}

function distanceToRoad(name, clickLatLng) {
  let min = Infinity;
  for (const seg of roadsByName[name]) {
    for (const [lat, lon] of seg) {
      const d = clickLatLng.distanceTo(L.latLng(lat, lon));
      if (d < min) min = d;
    }
  }
  return min;
}

function nearestRoadNode(name, clickLatLng) {
  let best = null, min = Infinity;
  for (const seg of roadsByName[name]) {
    for (const [lat, lon] of seg) {
      const d = clickLatLng.distanceTo(L.latLng(lat, lon));
      if (d < min) { min = d; best = L.latLng(lat, lon); }
    }
  }
  return best;
}

function clearFindMarkers() {
  if (findClickMarker) { map.removeLayer(findClickMarker); findClickMarker = null; }
  if (findClickLine)   { map.removeLayer(findClickLine);   findClickLine   = null; }
}

function startFindClick() { map.on('click',  handleFindClick); }
function stopFindClick()  { map.off('click', handleFindClick); }

function setMode(mode) {
  if (pendingTimer) { clearTimeout(pendingTimer); pendingTimer = null; }
  stopFindClick();
  clearFindMarkers();
  if (currentRoad) setRoadStyle(currentRoad, STYLE_DEFAULT);
  quizMode = mode;
  const isLearn = mode === 'learn';
  document.getElementById('name-mode-ui').style.display = (mode === 'name' || isLearn) ? '' : 'none';
  document.getElementById('find-mode-ui').style.display = mode === 'find' ? '' : 'none';
  document.getElementById('mode-name-btn').classList.toggle('active', mode === 'name');
  document.getElementById('mode-find-btn').classList.toggle('active', mode === 'find');
  document.getElementById('mode-learn-btn').classList.toggle('active', isLearn);
  document.getElementById('map').classList.toggle('find-mode', mode === 'find');
  document.getElementById('zoom-btn').style.display      = mode === 'find' ? 'none' : '';
  // Learn-mode swaps Skip → See Name, hides progress bar, relabels 4th score cell
  document.getElementById('skip-btn').style.display      = isLearn ? 'none' : '';
  document.getElementById('see-name-btn').style.display  = isLearn ? ''     : 'none';
  document.getElementById('progress-wrap').style.display = isLearn ? 'none' : '';
  document.getElementById('lbl-mastered').textContent    = isLearn ? 'Recalled' : 'Mastered';
  document.getElementById('hint-text').textContent       = isLearn
    ? 'Press Enter to submit \u2022 Esc to see name'
    : 'Press Enter to submit \u2022 Esc to skip';
  startQuiz();
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function activeNames() {
  let names = activeRoadNames || roadNames;
  if (arterialOnly) { const s = new Set(arterialRoadNames); names = names.filter(n => s.has(n)); }
  return names;
}

function startQuiz() {
  score.correct = score.total = score.streak = 0; mastered.clear();
  learnRevealed = false; learnRecalled = 0;
  quizQueue = shuffle([...activeNames()]);
  document.getElementById('completion').style.display = 'none';
  updateRoadList(); nextQuestion();
}

function nextQuestion() {
  if (quizMode === 'find') nextFindQuestion();
  else nextNameQuestion();
}

function nextNameQuestion() {
  awaitingNext  = false;
  learnRevealed = false;
  if (currentRoad) setRoadStyle(currentRoad, STYLE_DEFAULT);
  if (quizMode === 'learn') {
    // Infinite loop — refill from all active names, never complete
    if (quizQueue.length === 0) quizQueue = shuffle([...activeNames()]);
  } else {
    if (quizQueue.length === 0) {
      const unmastered = activeNames().filter(n => !mastered.has(n));
      if (unmastered.length === 0) { showCompletion(); return; }
      quizQueue = shuffle([...unmastered]);
    }
  }
  currentRoad = quizQueue.pop();
  setRoadStyle(currentRoad, STYLE_ACTIVE);
  roadLayers[currentRoad]?.eachLayer(l => l.bringToFront?.());
  zoomToRoad(currentRoad);
  const input = document.getElementById('answer-input');
  input.value = ''; input.className = ''; input.focus();
  const fb = document.getElementById('feedback'); fb.className = fb.textContent = '';
  document.getElementById('question-text').textContent = 'The road highlighted in red is — what is its name?';
  updateScore();
}

function nextFindQuestion() {
  clearFindMarkers();
  if (currentRoad) setRoadStyle(currentRoad, STYLE_DEFAULT);
  if (quizQueue.length === 0) {
    const unmastered = activeNames().filter(n => !mastered.has(n));
    if (unmastered.length === 0) { showCompletion(); return; }
    quizQueue = shuffle([...unmastered]);
  }
  currentRoad = quizQueue.pop();
  document.getElementById('find-road-name').textContent = currentRoad;
  const fb = document.getElementById('find-feedback'); fb.className = ''; fb.textContent = '';
  document.getElementById('find-next-btn').style.display = 'none';
  document.getElementById('find-skip-btn').style.display = '';
  document.getElementById('find-hint').style.display = '';
  updateScore();
  startFindClick();
}

function handleFindClick(e) {
  stopFindClick();
  const dist = distanceToRoad(currentRoad, e.latlng);
  const isCorrect = dist <= FIND_THRESHOLD;
  const distStr = dist < 1000 ? `${Math.round(dist)}m` : `${(dist / 1000).toFixed(1)}km`;

  findClickMarker = L.circleMarker(e.latlng, {
    radius: 9, color: isCorrect ? '#4caf50' : '#e05252',
    fillColor: isCorrect ? '#4caf50' : '#e05252', fillOpacity: 0.75, weight: 2,
  }).addTo(map);

  if (!isCorrect) {
    const nearest = nearestRoadNode(currentRoad, e.latlng);
    if (nearest) {
      findClickLine = L.polyline([e.latlng, nearest], {
        color: '#e05252', weight: 2, dashArray: '6 5', opacity: 0.65,
      }).addTo(map);
    }
  }

  score.total++;
  const fb = document.getElementById('find-feedback');
  if (isCorrect) {
    score.correct++; score.streak++; mastered.add(currentRoad);
    setRoadStyle(currentRoad, STYLE_CORRECT);
    fb.className = 'fb-ok';
    fb.textContent = `\u2713 Nice! You were ${distStr} away.`;
  } else {
    score.streak = 0;
    setRoadStyle(currentRoad, STYLE_SKIP);
    const closeTag = dist <= 800 ? 'Close! ' : '';
    fb.className = 'fb-bad';
    fb.textContent = `\u2717 ${closeTag}${distStr} away \u2014 the road is highlighted.`;
    quizQueue.splice(Math.floor(Math.random() * Math.min(5, quizQueue.length + 1)), 0, currentRoad);
  }

  roadLayers[currentRoad]?.eachLayer(l => l.bringToFront?.());
  zoomToRoad(currentRoad);

  document.getElementById('find-next-btn').style.display = '';
  document.getElementById('find-skip-btn').style.display = 'none';
  document.getElementById('find-hint').style.display = 'none';

  updateScore(); updateRoadList();
  pendingTimer = setTimeout(nextQuestion, isCorrect ? 2500 : 3500);
}

function skipFindRoad() {
  stopFindClick();
  if (document.getElementById('find-next-btn').style.display !== 'none') {
    // already answered — treat Next click as skip
    if (pendingTimer) { clearTimeout(pendingTimer); pendingTimer = null; }
    nextQuestion(); return;
  }
  score.total++; score.streak = 0;
  setRoadStyle(currentRoad, STYLE_SKIP);
  roadLayers[currentRoad]?.eachLayer(l => l.bringToFront?.());
  zoomToRoad(currentRoad);
  const fb = document.getElementById('find-feedback');
  fb.className = 'fb-skip';
  fb.textContent = `Skipped \u2014 the road is highlighted.`;
  quizQueue.splice(Math.floor(Math.random() * Math.min(5, quizQueue.length + 1)), 0, currentRoad);
  document.getElementById('find-next-btn').style.display = '';
  document.getElementById('find-skip-btn').style.display = 'none';
  document.getElementById('find-hint').style.display = 'none';
  updateScore();
  pendingTimer = setTimeout(nextQuestion, 2500);
}

function normalise(name) {
  return name.toLowerCase().trim()
    .replace(/\brd\b\.?/g, 'road').replace(/\bave\b\.?/g, 'avenue').replace(/\bav\b\.?/g, 'avenue')
    .replace(/\bdr\b\.?/g, 'drive').replace(/\bblvd\b\.?/g, 'boulevard').replace(/\bln\b\.?/g, 'lane')
    .replace(/\bct\b\.?/g, 'court').replace(/\bpl\b\.?/g, 'place').replace(/\bhwy\b\.?/g, 'highway')
    .replace(/\s+/g, ' ');
}

function isAccepted(userInput, correctName) {
  const normUser = normalise(userInput), normCorrect = normalise(correctName);
  if (normUser === normCorrect) return true;
  const escaped = normUser.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  return new RegExp('(?:^|\\s)' + escaped + '(?:\\s|$)').test(normCorrect);
}

function checkAnswer() {
  if (awaitingNext) { nextQuestion(); return; }
  const input = document.getElementById('answer-input'), userInput = input.value.trim();
  if (!userInput) return;
  const isCorrect = isAccepted(userInput, currentRoad);
  const fb = document.getElementById('feedback');

  if (quizMode === 'learn') {
    if (learnRevealed) {
      // Typing to confirm after peeking — just need a match to advance
      if (isCorrect) {
        input.className = 'state-ok'; fb.className = 'fb-ok';
        fb.textContent = '\u2713 ' + currentRoad;
        setRoadStyle(currentRoad, STYLE_CORRECT); awaitingNext = true;
        updateScore(); pendingTimer = setTimeout(nextQuestion, 1200);
      } else {
        input.className = 'state-bad'; // keep the fb-skip message visible
      }
    } else {
      // Self-recalled without peeking
      if (isCorrect) {
        score.correct++; score.total++; score.streak++; learnRecalled++;
        input.className = 'state-ok'; fb.className = 'fb-ok';
        fb.textContent = '\u2713 ' + currentRoad;
        setRoadStyle(currentRoad, STYLE_CORRECT); awaitingNext = true;
        // Requeue further back — you know it, but keep it cycling
        const pos = Math.max(0, quizQueue.length - (Math.floor(Math.random() * 7) + 6));
        quizQueue.splice(pos, 0, currentRoad);
        updateScore(); pendingTimer = setTimeout(nextQuestion, 1600);
      } else {
        score.streak = 0; input.className = 'state-bad'; fb.className = 'fb-bad';
        fb.textContent = 'Not quite — try again, or click See Name.';
        updateScore();
      }
    }
    return;
  }

  // Normal Name That Road mode
  score.total++;
  if (isCorrect) {
    score.correct++; score.streak++; mastered.add(currentRoad);
    input.className = 'state-ok'; fb.className = 'fb-ok'; fb.textContent = 'Correct! ' + currentRoad;
    setRoadStyle(currentRoad, STYLE_CORRECT); awaitingNext = true;
    updateScore(); updateRoadList(); pendingTimer = setTimeout(nextQuestion, 1600);
  } else {
    score.streak = 0; input.className = 'state-bad'; fb.className = 'fb-bad';
    fb.textContent = 'Not quite — try again, or press Skip to reveal.'; updateScore();
  }
}

function seeRoadName() {
  if (awaitingNext || learnRevealed) return;
  learnRevealed = true;
  const input = document.getElementById('answer-input');
  const fb    = document.getElementById('feedback');
  input.value = '';
  input.className = 'state-skip';
  fb.className    = 'fb-skip';
  fb.textContent  = currentRoad + ' \u2014 type it above to continue';
  setRoadStyle(currentRoad, STYLE_SKIP);
  roadLayers[currentRoad]?.eachLayer(l => l.bringToFront?.());
  // Requeue closer — needs more repetition after a peek
  const pos = Math.max(0, quizQueue.length - (Math.floor(Math.random() * 3) + 2));
  quizQueue.splice(pos, 0, currentRoad);
  input.focus();
}

function skipRoad() {
  if (awaitingNext) return;
  const input = document.getElementById('answer-input'), fb = document.getElementById('feedback');
  score.total++; score.streak = 0;
  input.value = currentRoad; input.className = 'state-skip'; fb.className = 'fb-skip';
  fb.textContent = 'Answer: ' + currentRoad + ' — it will come back around.';
  setRoadStyle(currentRoad, STYLE_SKIP);
  quizQueue.splice(Math.floor(Math.random() * Math.min(5, quizQueue.length + 1)), 0, currentRoad);
  updateScore(); awaitingNext = true; pendingTimer = setTimeout(nextQuestion, 2200);
}

function showCompletion() {
  const names = activeNames(), pct = score.total > 0 ? Math.round(score.correct / score.total * 100) : 0;
  const el = document.getElementById('completion');
  el.style.display = 'block';
  el.textContent = `All ${names.length} roads mastered! Final score: ${score.correct}/${score.total} (${pct}%). Hit Reset to go again.`;
  if (quizMode === 'name') document.getElementById('question-text').textContent = 'Quiz complete — great work!';
  else document.getElementById('find-road-name').textContent = 'Quiz complete!';
  if (currentRoad) setRoadStyle(currentRoad, STYLE_DEFAULT);
}

function updateRoadCountLabel() {
  const lbl = document.getElementById('road-count-lbl'), showing = activeNames().length, total = roadNames.length;
  lbl.textContent = showing < total ? `(${showing} of ${total})` : `(${total})`;
}

function updateScore() {
  const names = activeNames();
  document.getElementById('val-correct').textContent  = score.correct;
  document.getElementById('val-total').textContent    = score.total;
  document.getElementById('val-streak').textContent   = score.streak;
  document.getElementById('val-mastered').textContent = quizMode === 'learn' ? learnRecalled : mastered.size;
  const pct = names.length > 0 ? (mastered.size / names.length * 100).toFixed(0) : 0;
  document.getElementById('progress-bar-fill').style.width = pct + '%';
  document.getElementById('progress-label').textContent    = `${mastered.size} of ${names.length} roads mastered`;
  const acc = score.total > 0 ? Math.round(score.correct / score.total * 100) : 0;
  document.getElementById('header-stats').textContent = `${score.correct}/${score.total} correct (${acc}%)  |  Streak: ${score.streak}`;
}

function updateRoadList() {
  const names = activeNames(), list = document.getElementById('road-list');
  list.innerHTML = '';
  for (const name of names) {
    const div = document.createElement('div');
    div.className   = 'road-item' + (mastered.has(name) ? ' mastered' : '');
    div.textContent = (mastered.has(name) ? '\u2713 ' : '') + name;
    list.appendChild(div);
  }
}

document.getElementById('submit-btn').addEventListener('click', checkAnswer);
document.getElementById('skip-btn').addEventListener('click',   skipRoad);
document.getElementById('zoom-btn').addEventListener('click',   () => { if (currentRoad) zoomToRoad(currentRoad); });
document.getElementById('reset-btn').addEventListener('click',  () => { if (confirm('Reset the quiz and start over?')) startQuiz(); });
document.getElementById('arterial-btn').addEventListener('click',  toggleArterial);
document.getElementById('area-btn').addEventListener('click',       enterSelectionMode);
document.getElementById('clear-area-btn').addEventListener('click', clearAreaSelection);
document.getElementById('answer-input').addEventListener('keydown', e => {
  if (e.key === 'Enter')  checkAnswer();
  if (e.key === 'Escape') quizMode === 'learn' ? seeRoadName() : skipRoad();
});
document.getElementById('mode-name-btn').addEventListener('click',  () => setMode('name'));
document.getElementById('mode-find-btn').addEventListener('click',  () => setMode('find'));
document.getElementById('mode-learn-btn').addEventListener('click', () => setMode('learn'));
document.getElementById('see-name-btn').addEventListener('click',   seeRoadName);
document.getElementById('find-next-btn').addEventListener('click', () => {
  if (pendingTimer) { clearTimeout(pendingTimer); pendingTimer = null; }
  nextQuestion();
});
document.getElementById('find-skip-btn').addEventListener('click', skipFindRoad);
document.addEventListener('keydown', e => {
  if (quizMode === 'find' && e.key === 'Escape') skipFindRoad();
});

async function init() {
  try {
    const data  = await fetchRoads();
    roadsByName = parseRoads(data);
    roadNames   = Object.keys(roadsByName).sort();

    // Build arterial road list: roads with an arterial OSM type, plus any named overrides
    arterialRoadNames = roadNames.filter(name =>
      NAMED_ARTERIALS.has(name) ||
      (roadHighwayTypes[name] && [...roadHighwayTypes[name]].some(t => ARTERIAL_TYPES.has(t)))
    );

    updateRoadCountLabel(); renderRoads(); updateRoadList();
    document.getElementById('loading').style.display = 'none';
    startQuiz();
  } catch (err) {
    document.getElementById('loading').innerHTML = `
      <div style="color:#e05252;font-size:1rem;margin-bottom:8px;">Failed to load road data</div>
      <div style="color:#5a6380;font-size:0.82rem;max-width:300px;text-align:center;margin-bottom:16px;">${err.message}</div>
      <button onclick="location.reload()" style="padding:9px 22px;background:#e05252;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:0.9rem;">Retry</button>`;
  }
}
init();
</script>
</body>
</html>
